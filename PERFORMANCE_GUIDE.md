# راهنمای بهینه‌سازی عملکرد ربات تلگرام

## مقدمه

این سند شامل مجموعه‌ای از بهینه‌سازی‌های انجام شده برای بهبود عملکرد ربات تلگرام دانلودر است. هدف از این بهینه‌سازی‌ها افزایش سرعت، کاهش مصرف منابع و حذف وابستگی به aria2c است که در محیط‌های مختلف مانند Railway محدود شده است.

## بهینه‌سازی‌های اصلی

### 1. مدیریت حافظه کش (cache_optimizer.py)

این اسکریپت عملیات زیر را انجام می‌دهد:

- **پاکسازی فایل‌های منقضی**: فایل‌های قدیمی‌تر از 3 روز به صورت خودکار حذف می‌شوند.
- **مدیریت حجم کش**: حجم کلی کش به 1 گیگابایت محدود می‌شود.
- **پاکسازی دایرکتوری‌های خالی**: دایرکتوری‌های بدون فایل حذف می‌شوند.
- **حذف فایل‌های موقت**: فایل‌های موقت yt-dlp و دیگر فایل‌های .part پاکسازی می‌شوند.

برای استفاده مستقیم:
```python
from cache_optimizer import run_optimization
run_optimization()
```

### 2. پردازش پیشرفته ویدیو (video_processor.py)

این ماژول پردازش بهینه ویدیو را ارائه می‌دهد:

- **تبدیل کیفیت بهینه**: با استفاده از تنظیمات مناسب ffmpeg برای کارایی بهتر
- **استخراج صدا**: استخراج بهینه صدا از ویدیو
- **بهینه‌سازی برای تلگرام**: کاهش هوشمند حجم فایل‌های بزرگ برای آپلود در تلگرام (حداکثر 50 مگابایت)

برای استفاده:
```python
from video_processor import convert_video_quality, extract_audio, optimize_for_telegram

# تبدیل کیفیت ویدیو
convert_video_quality('/path/to/video.mp4', '720p')

# استخراج صدا
extract_audio('/path/to/video.mp4', 'mp3', '192k')

# بهینه‌سازی برای تلگرام
optimize_for_telegram('/path/to/video.mp4', 50)
```

### 3. بهینه‌سازی تنظیمات yt-dlp (yt_dlp_optimizer.py)

این اسکریپت تنظیمات yt-dlp را برای عملکرد بهتر بهینه می‌کند:

- **حذف اشارات به aria2c**: تمام اشارات به aria2c از کد حذف می‌شوند.
- **تنظیمات بهینه**: پارامترهای بهینه برای محیط‌های با منابع محدود اعمال می‌شوند.
- **بهبود سازگاری**: سازگاری با محیط‌هایی مانند Railway را بهبود می‌بخشد.

برای استفاده:
```python
from yt_dlp_optimizer import apply_ytdlp_optimization
apply_ytdlp_optimization()
```

### 4. اسکریپت راه‌اندازی بهینه (optimizer_startup.sh)

این اسکریپت تمام مراحل بهینه‌سازی را به صورت خودکار اجرا می‌کند:

- پاکسازی فایل‌های قفل و موقت
- تنظیم متغیرهای محیطی برای کارایی بهتر
- پاکسازی حافظه کش
- حذف وابستگی‌های aria2c
- اجرای بهینه‌سازی‌های yt-dlp

برای استفاده:
```bash
chmod +x optimizer_startup.sh
./optimizer_startup.sh
```

## راه‌اندازی در محیط‌های مختلف

### راه‌اندازی در Replit

1. فایل‌های بهینه‌سازی را به پروژه اضافه کنید
2. اسکریپت راه‌اندازی را اجرا کنید:
```bash
./optimizer_startup.sh
```

### راه‌اندازی در Railway

1. در فایل railway.toml یا railway.json تنظیمات زیر را اضافه کنید:
```toml
[build]
builder = "nixpacks"
```

2. در بخش تنظیمات Railway، متغیرهای محیطی زیر را اضافه کنید:
```
TELEGRAM_BOT_TOKEN=<token_bot_shoma>
YDL_NO_ARIA2C=1
HTTP_DOWNLOADER=native
```

3. در بخش تنظیمات Railway، دستور شروع را به `bash railway_startup.sh` تغییر دهید.

## بهینه‌سازی‌های اضافی

### بهینه‌سازی حافظه موقت

این تابع در telegram_downloader.py اضافه شده است:
```python
def clean_temp_files():
    """پاکسازی فایل‌های موقت قدیمی"""
    try:
        # استفاده از بهینه‌ساز کش در صورت در دسترس بودن
        from cache_optimizer import run_optimization
        run_optimization()
    except ImportError:
        # روش پاکسازی قدیمی...
```

### برنامه زمان‌بندی پاکسازی خودکار

پاکسازی خودکار هر 6 ساعت اجرا می‌شود:
```python
async def scheduled_cache_optimization(context):
    try:
        from cache_optimizer import run_optimization
        run_optimization()
    except Exception as e:
        logger.error(f"خطا در اجرای بهینه‌سازی دوره‌ای کش: {e}")

# افزودن زمان‌بندی پاکسازی
job_queue = application.job_queue
job_queue.run_repeating(scheduled_cache_optimization, interval=21600, first=21600)
```

## نکات مهم

1. **حذف aria2c**: تمام اشارات به aria2c از کد حذف شده‌اند تا سازگاری بیشتری با محیط‌های محدود داشته باشد.
2. **مدیریت حافظه**: سیستم مدیریت هوشمند حافظه کش، مصرف دیسک را کنترل می‌کند.
3. **سرعت دانلود**: با حذف وابستگی به aria2c، از دانلودر داخلی yt-dlp استفاده می‌شود.
4. **سازگاری**: تست‌های گسترده‌ای در محیط‌های Replit و Railway انجام شده است.

## عیب‌یابی

در صورت بروز مشکل در اجرای موارد فوق:

1. اطمینان حاصل کنید که متغیر محیطی TELEGRAM_BOT_TOKEN تنظیم شده است.
2. بررسی کنید که دایرکتوری `/tmp` قابل نوشتن باشد.
3. اگر در Railway با خطای "Banned Dependency" مواجه شدید، فایل‌های راهنمای RAILWAY_DEPLOY_GUIDE.md و RAILWAY_QUICK_FIX.md را مطالعه کنید.

## نتیجه

با استفاده از این بهینه‌سازی‌ها، عملکرد ربات شما باید به طور قابل توجهی بهبود یابد. این بهینه‌سازی‌ها به ویژه در محیط‌های با منابع محدود مانند Railway مؤثر خواهند بود.